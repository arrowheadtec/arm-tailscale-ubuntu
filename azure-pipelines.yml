parameters:
- name: tailscaleKey
  displayName: TailScale Pre-auth Key
  type: string
  default: tskey-123replaceme321
- name: tailscaleRoutes
  displayName: Subnet routes for this node
  default: 192.168.64.0/24,10.64.0.0/16
- name: image
  displayName: Pool Image
  type: string
  default: ubuntu-latest
  values:
  - ubuntu-latest
  - ubuntu-20.04
- name: adminKey
  displayName: SSH Key for admin user
  type: string
  default: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCvd7m/4NgGLkAV6GUUTsl6Tfx0NwGDDWK4JM0eiXX5yOvJ63tVbyeMO6I7LZTjSVo2Ah9LpIOmixQSLbdOd6fIwj6s4tmHu9X9R3KvJ1JE4VApbFprOAaBFTo1lESoZ9ch3X2UaCYMl/sGO7ky22fusho7UUZn+cWlX34y+fhtggeJVrG8SzftyuqgRT27GTEE6oyYJZXsPTVah74yEPWHBMt4n5qcnTkfIkCSy3eqyYNypesRR4ArYv3lyiHAL9NGNDr1iXpl4/RiEy9vTQepXN0UUOmfIKo1nj5p4E2f+CHf2eYmMUqDB0xJInK0cTUml9m2X/VTq6aTnVF2VOXLGkluvLUqdLkcLHfYC+xHF47tKlvuWKiQwzvDViUoNlIW5ai8cIt7Pk9HUWHZ5+Xf+sk+VnZfELYnnAc2xMFJxFFqssVINW2tm0eQIeV9iWrymlHNWj0h23eb0oTM2uJ8s/+tg4MtQcAbOPePj2bfats8fa27TXdGup/zZXlJvac= rakhesh
- name: addressSpace
  displayName: Address space (also used as subnet) of the TailScale VM vnet
  type: string
  default: 192.168.64.0/24

# I'd like to run this manually
trigger: none

jobs:
- job: deploy
  displayName: Deploy to Azure
  pool: 
    vmImage: ${{ parameters.image }}
  steps:
  - script: sed -i "s|__REPLACEKEY__|${{ parameters.tailscaleKey }}|g; s|__REPLACEROUTES__|${{ parameters.tailscaleRoutes }}|g" artifacts/cloud-init.txt
    displayName: Update cloud-init.txt with the input paramters
  - script: cat artifacts/cloud-init.txt
    displayName: Show the updated cloud-init.txt file
  - pwsh: 
      $file = Get-Content -Path ./artifacts/azuredeploy.parameters.json -Raw | ConvertFrom-Json ;
      $file.parameters.adminKey.value = "${{ parameters.adminKey }}" ;
      $file.parameters.addressSpace.value = "${{ parameters.addressSpace }}" ;
      $file | ConvertTo-Json -Depth 15 | Set-Content ./artifacts/azuredeploy.parameters.json ;
      Get-Content -Path ./artifacts/azuredeploy.parameters.json -Raw
    displayName: Update ARM template parameters file